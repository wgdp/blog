name: Create Monthly Post

on:
  schedule:
    - cron: "0 15 1 * *" # æ¯æœˆ1æ—¥ JST 0:00 (UTC 15:00)
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨

jobs:
  create-post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop # developãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create Monthly Post
        run: |
          # æ—¥ä»˜è¨ˆç®—
          current_date=$(TZ=Asia/Tokyo date '+%Y-%m-%d')
          last_month_date=$(TZ=Asia/Tokyo date -d "last month" '+%Y-%m')
          last_month=$(TZ=Asia/Tokyo date -d "last month" '+%Yå¹´%mæœˆ')

          # æ–°ã—ã„è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆå‰æœˆã®å¹´æœˆã‚’ä½¿ç”¨ï¼‰
          new_post_path="src/pages/posts/${last_month_date}.md"

          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
          cp templates/monthly-template.md "$new_post_path"

          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
          sed -i "s/{% pub-date %}/$current_date/g" "$new_post_path"
          sed -i "s/{% month %}/$last_month/g" "$new_post_path"

          echo "Created monthly post for $last_month at $new_post_path"

          # Gitè¨­å®š
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "$new_post_path"
          git commit -m "ğŸ“ Add monthly post for $last_month"
          git push

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" -X POST -d '{
            "content": "@whigdrap æœˆåˆã‚ã ï¼æ€¥ã„ã§ä»Šæœˆã®è¨˜äº‹ã‚’æ›¸ãã‚“ã ï¼\nä»Šã™ãã‚„ã‚Œï¼ï¼",
            "embeds": [{
              "image": {
                "url": "https://image.r2.cloudflare.wgdp.dev/imasuguyare.webp"
              }
            }]
          }' $DISCORD_WEBHOOK
